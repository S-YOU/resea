.intel_syntax noprefix

.macro SAVE_REGS
  push  r15
  push  r14
  push  r13
  push  r12
  push  r11
  push  r10
  push  r9
  push  r8
  push  rbp
  push  rdi
  push  rsi
  push  rdx
  push  rcx
  push  rbx
  push  rax
.endm

.macro RESTORE_REGS
  pop   rax
  pop   rbx
  pop   rcx
  pop   rdx
  pop   rsi
  pop   rdi
  pop   rbp
  pop   r8
  pop   r9
  pop   r10
  pop   r11
  pop   r12
  pop   r13
  pop   r14
  pop   r15
.endm

.extern x64_handle_irq
.macro INTR_HANDLER num
.align 8
.globl x64_irq_handler\num
x64_irq_handler\num:
    cli
    SAVE_REGS

    mov rdi, \num
    call x64_handle_irq

    RESTORE_REGS
    iretq
.endm

.extern x64_handle_exception
.macro EXP_HANDLER_WITH_ERRCODE num
.align 8
.globl  x64_exp_handler\num
x64_exp_handler\num:
    cli
    /* Get error code from the stack and overwrite by SAVE_REGS. */
    push rax
    mov  rax, [rsp + 8]
    mov  [rsp - 112], rax
    pop  rax
    add  rsp, 8

    SAVE_REGS

    mov  rsi, [rsp + 120] /* error code */
    mov  rdi, \num
    call x64_handle_exception

    RESTORE_REGS
    iretq
.endm

.macro EXP_HANDLER_WITHOUT_ERRCODE num
.align 8
.globl x64_exp_handler\num
x64_exp_handler\num:
    cli
    SAVE_REGS

    mov  rdi, \num
    call x64_handle_exception

    RESTORE_REGS
    iretq
.endm

.extern x64_handle_unkown_irq
.globl x64_unknown_irq_handler
.align 8
x64_unknown_irq_handler:
    cli
    SAVE_REGS

    call x64_handle_unkown_irq

    RESTORE_REGS
    iretq

EXP_HANDLER_WITHOUT_ERRCODE 0
EXP_HANDLER_WITHOUT_ERRCODE 1
EXP_HANDLER_WITHOUT_ERRCODE 2
EXP_HANDLER_WITHOUT_ERRCODE 3
EXP_HANDLER_WITHOUT_ERRCODE 4
EXP_HANDLER_WITHOUT_ERRCODE 5
EXP_HANDLER_WITHOUT_ERRCODE 6
EXP_HANDLER_WITHOUT_ERRCODE 7
EXP_HANDLER_WITH_ERRCODE    8
EXP_HANDLER_WITHOUT_ERRCODE 9
EXP_HANDLER_WITH_ERRCODE    10
EXP_HANDLER_WITH_ERRCODE    11
EXP_HANDLER_WITH_ERRCODE    12
EXP_HANDLER_WITH_ERRCODE    13
EXP_HANDLER_WITH_ERRCODE    14
EXP_HANDLER_WITH_ERRCODE    15
EXP_HANDLER_WITHOUT_ERRCODE 16
EXP_HANDLER_WITH_ERRCODE    17
EXP_HANDLER_WITHOUT_ERRCODE 18
EXP_HANDLER_WITHOUT_ERRCODE 19
EXP_HANDLER_WITHOUT_ERRCODE 20

INTR_HANDLER 0x20
INTR_HANDLER 0x21
INTR_HANDLER 0x22
INTR_HANDLER 0x23
INTR_HANDLER 0x24
INTR_HANDLER 0x25
INTR_HANDLER 0x26
INTR_HANDLER 0x27
INTR_HANDLER 0x28
INTR_HANDLER 0x29
INTR_HANDLER 0x2a
INTR_HANDLER 0x2b
INTR_HANDLER 0x2c
INTR_HANDLER 0x2d
INTR_HANDLER 0x2e
INTR_HANDLER 0x2f
INTR_HANDLER 0x30
INTR_HANDLER 0x31
INTR_HANDLER 0x32
INTR_HANDLER 0x33
INTR_HANDLER 0x34
INTR_HANDLER 0x35
INTR_HANDLER 0x36
INTR_HANDLER 0x37
INTR_HANDLER 0x38
INTR_HANDLER 0x39
INTR_HANDLER 0x3a
INTR_HANDLER 0x3b
INTR_HANDLER 0x3c
INTR_HANDLER 0x3d
INTR_HANDLER 0x3e
INTR_HANDLER 0x3f
INTR_HANDLER 0x40
INTR_HANDLER 0x41
INTR_HANDLER 0x42
INTR_HANDLER 0x43
INTR_HANDLER 0x44
INTR_HANDLER 0x45
INTR_HANDLER 0x46
INTR_HANDLER 0x47
INTR_HANDLER 0x48
INTR_HANDLER 0x49
INTR_HANDLER 0x4a
INTR_HANDLER 0x4b
INTR_HANDLER 0x4c
INTR_HANDLER 0x4d
INTR_HANDLER 0x4e
INTR_HANDLER 0x4f
INTR_HANDLER 0x50
INTR_HANDLER 0x51
INTR_HANDLER 0x52
INTR_HANDLER 0x53
INTR_HANDLER 0x54
INTR_HANDLER 0x55
INTR_HANDLER 0x56
INTR_HANDLER 0x57
INTR_HANDLER 0x58
INTR_HANDLER 0x59
INTR_HANDLER 0x5a
INTR_HANDLER 0x5b
INTR_HANDLER 0x5c
INTR_HANDLER 0x5d
INTR_HANDLER 0x5e
INTR_HANDLER 0x5f
INTR_HANDLER 0x60
INTR_HANDLER 0x61
INTR_HANDLER 0x62
INTR_HANDLER 0x63
INTR_HANDLER 0x64
INTR_HANDLER 0x65
INTR_HANDLER 0x66
INTR_HANDLER 0x67
INTR_HANDLER 0x68
INTR_HANDLER 0x69
INTR_HANDLER 0x6a
INTR_HANDLER 0x6b
INTR_HANDLER 0x6c
INTR_HANDLER 0x6d
INTR_HANDLER 0x6e
INTR_HANDLER 0x6f
INTR_HANDLER 0x70
INTR_HANDLER 0x71
INTR_HANDLER 0x72
INTR_HANDLER 0x73
INTR_HANDLER 0x74
INTR_HANDLER 0x75
INTR_HANDLER 0x76
INTR_HANDLER 0x77
INTR_HANDLER 0x78
INTR_HANDLER 0x79
INTR_HANDLER 0x7a
INTR_HANDLER 0x7b
INTR_HANDLER 0x7c
INTR_HANDLER 0x7d
INTR_HANDLER 0x7e
INTR_HANDLER 0x7f
INTR_HANDLER 0x80
INTR_HANDLER 0x81
INTR_HANDLER 0x82
INTR_HANDLER 0x83
INTR_HANDLER 0x84
INTR_HANDLER 0x85
INTR_HANDLER 0x86
INTR_HANDLER 0x87
INTR_HANDLER 0x88
INTR_HANDLER 0x89
INTR_HANDLER 0x8a
INTR_HANDLER 0x8b
INTR_HANDLER 0x8c
INTR_HANDLER 0x8d
INTR_HANDLER 0x8e
INTR_HANDLER 0x8f
INTR_HANDLER 0x90
INTR_HANDLER 0x91
INTR_HANDLER 0x92
INTR_HANDLER 0x93
INTR_HANDLER 0x94
INTR_HANDLER 0x95
INTR_HANDLER 0x96
INTR_HANDLER 0x97
INTR_HANDLER 0x98
INTR_HANDLER 0x99
INTR_HANDLER 0x9a
INTR_HANDLER 0x9b
INTR_HANDLER 0x9c
INTR_HANDLER 0x9d
INTR_HANDLER 0x9e
INTR_HANDLER 0x9f
INTR_HANDLER 0xa0
INTR_HANDLER 0xa1
INTR_HANDLER 0xa2
INTR_HANDLER 0xa3
INTR_HANDLER 0xa4
INTR_HANDLER 0xa5
INTR_HANDLER 0xa6
INTR_HANDLER 0xa7
INTR_HANDLER 0xa8
INTR_HANDLER 0xa9
INTR_HANDLER 0xaa
INTR_HANDLER 0xab
INTR_HANDLER 0xac
INTR_HANDLER 0xad
INTR_HANDLER 0xae
INTR_HANDLER 0xaf
INTR_HANDLER 0xb0
INTR_HANDLER 0xb1
INTR_HANDLER 0xb2
INTR_HANDLER 0xb3
INTR_HANDLER 0xb4
INTR_HANDLER 0xb5
INTR_HANDLER 0xb6
INTR_HANDLER 0xb7
INTR_HANDLER 0xb8
INTR_HANDLER 0xb9
INTR_HANDLER 0xba
INTR_HANDLER 0xbb
INTR_HANDLER 0xbc
INTR_HANDLER 0xbd
INTR_HANDLER 0xbe
INTR_HANDLER 0xbf
INTR_HANDLER 0xc0
INTR_HANDLER 0xc1
INTR_HANDLER 0xc2
INTR_HANDLER 0xc3
INTR_HANDLER 0xc4
INTR_HANDLER 0xc5
INTR_HANDLER 0xc6
INTR_HANDLER 0xc7
INTR_HANDLER 0xc8
INTR_HANDLER 0xc9
INTR_HANDLER 0xca
INTR_HANDLER 0xcb
INTR_HANDLER 0xcc
INTR_HANDLER 0xcd
INTR_HANDLER 0xce
INTR_HANDLER 0xcf
INTR_HANDLER 0xd0
INTR_HANDLER 0xd1
INTR_HANDLER 0xd2
INTR_HANDLER 0xd3
INTR_HANDLER 0xd4
INTR_HANDLER 0xd5
INTR_HANDLER 0xd6
INTR_HANDLER 0xd7
INTR_HANDLER 0xd8
INTR_HANDLER 0xd9
INTR_HANDLER 0xda
INTR_HANDLER 0xdb
INTR_HANDLER 0xdc
INTR_HANDLER 0xdd
INTR_HANDLER 0xde
INTR_HANDLER 0xdf
INTR_HANDLER 0xe0
INTR_HANDLER 0xe1
INTR_HANDLER 0xe2
INTR_HANDLER 0xe3
INTR_HANDLER 0xe4
INTR_HANDLER 0xe5
INTR_HANDLER 0xe6
INTR_HANDLER 0xe7
INTR_HANDLER 0xe8
INTR_HANDLER 0xe9
INTR_HANDLER 0xea
INTR_HANDLER 0xeb
INTR_HANDLER 0xec
INTR_HANDLER 0xed
INTR_HANDLER 0xee
INTR_HANDLER 0xef
INTR_HANDLER 0xf0
INTR_HANDLER 0xf1
INTR_HANDLER 0xf2
INTR_HANDLER 0xf3
INTR_HANDLER 0xf4
INTR_HANDLER 0xf5
INTR_HANDLER 0xf6
INTR_HANDLER 0xf7
INTR_HANDLER 0xf8
INTR_HANDLER 0xf9
INTR_HANDLER 0xfa
INTR_HANDLER 0xfb
INTR_HANDLER 0xfc
INTR_HANDLER 0xfd
INTR_HANDLER 0xfe
